<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />




<title>Mapping in R with {sf}</title>

<script src="site_libs/header-attrs-2.3/header-attrs.js"></script>
<script src="site_libs/jquery-1.12.4/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/cosmo.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<script src="site_libs/jqueryui-1.11.4/jquery-ui.min.js"></script>
<link href="site_libs/tocify-1.9.1/jquery.tocify.css" rel="stylesheet" />
<script src="site_libs/tocify-1.9.1/jquery.tocify.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/highlightjs-9.12.0/textmate.css" rel="stylesheet" />
<script src="site_libs/highlightjs-9.12.0/highlight.js"></script>
<script src="site_libs/htmlwidgets-1.5.1/htmlwidgets.js"></script>
<link href="site_libs/leaflet-1.3.1/leaflet.css" rel="stylesheet" />
<script src="site_libs/leaflet-1.3.1/leaflet.js"></script>
<link href="site_libs/leafletfix-1.0.0/leafletfix.css" rel="stylesheet" />
<script src="site_libs/Proj4Leaflet-1.0.1/proj4-compressed.js"></script>
<script src="site_libs/Proj4Leaflet-1.0.1/proj4leaflet.js"></script>
<link href="site_libs/rstudio_leaflet-1.3.1/rstudio_leaflet.css" rel="stylesheet" />
<script src="site_libs/leaflet-binding-2.0.3/leaflet.js"></script>
<script src="site_libs/leaflet-providers-1.9.0/leaflet-providers_1.9.0.js"></script>
<script src="site_libs/leaflet-providers-plugin-2.0.3/leaflet-providers-plugin.js"></script>
<script src="site_libs/FlatGeoBuf-3.3.3/fgb.js"></script>
<script src="site_libs/FlatGeoBuf-3.3.3/flatgeobuf-geojson.min.js"></script>
<script src="site_libs/chromajs-2.1.0/chroma.min.js"></script>
<link id="df_sf-1-attachment" rel="attachment" href="site_libs/df_sf-0.0.1/df_sf_layer.fgb"/>
<link href="site_libs/HomeButton-0.0.1/home-button.css" rel="stylesheet" />
<script src="site_libs/HomeButton-0.0.1/home-button.js"></script>
<script src="site_libs/HomeButton-0.0.1/easy-button-src.min.js"></script>
<script src="site_libs/clipboard-0.0.1/setClipboardText.js"></script>
<link href="site_libs/mapviewCSS-0.0.1/mapview-popup.css" rel="stylesheet" />
<link href="site_libs/mapviewCSS-0.0.1/mapview.css" rel="stylesheet" />
<link id="CSCI-1-attachment" rel="attachment" href="site_libs/CSCI-0.0.1/CSCI_layer.fgb"/>
<link id="SacramentoCounty-1-attachment" rel="attachment" href="site_libs/SacramentoCounty-0.0.1/SacramentoCounty_layer.fgb"/>
<link id="tst_shp-1-attachment" rel="attachment" href="site_libs/tst_shp-0.0.1/tst_shp_layer.fgb"/>
<link href="site_libs/font-awesome-5.1.0/css/all.css" rel="stylesheet" />
<link href="site_libs/font-awesome-5.1.0/css/v4-shims.css" rel="stylesheet" />
<link href="site_libs/ionicons-2.0.1/css/ionicons.min.css" rel="stylesheet" />
<link rel="stylesheet" href="site_libs_extra/academicons-1.8.0/css/academicons.css"/>

<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>



<style type="text/css">
h1 {
  font-size: 34px;
}
h1.title {
  font-size: 38px;
}
h2 {
  font-size: 30px;
}
h3 {
  font-size: 24px;
}
h4 {
  font-size: 18px;
}
h5 {
  font-size: 16px;
}
h6 {
  font-size: 12px;
}
.table th:not([align]) {
  text-align: left;
}
</style>

<link rel="stylesheet" href="styles.css" type="text/css" />



<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
</style>


<style type="text/css">
/* padding for bootstrap navbar */
body {
  padding-top: 51px;
  padding-bottom: 40px;
}
/* offset scroll position for anchor links (for fixed navbar)  */
.section h1 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h2 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h3 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h4 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h5 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h6 {
  padding-top: 56px;
  margin-top: -56px;
}
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #ffffff;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script>
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.parent().addClass('active');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  background: white;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "&#xe258;";
  border: none;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->



<style type="text/css">

#TOC {
  margin: 25px 0px 20px 0px;
}
@media (max-width: 768px) {
#TOC {
  position: relative;
  width: 100%;
}
}

@media print {
.toc-content {
  /* see https://github.com/w3c/csswg-drafts/issues/4434 */
  float: right;
}
}

.toc-content {
  padding-left: 30px;
  padding-right: 40px;
}

div.main-container {
  max-width: 1200px;
}

div.tocify {
  width: 20%;
  max-width: 260px;
  max-height: 85%;
}

@media (min-width: 768px) and (max-width: 991px) {
  div.tocify {
    width: 25%;
  }
}

@media (max-width: 767px) {
  div.tocify {
    width: 100%;
    max-width: none;
  }
}

.tocify ul, .tocify li {
  line-height: 20px;
}

.tocify-subheader .tocify-item {
  font-size: 0.90em;
}

.tocify .list-group-item {
  border-radius: 0px;
}


</style>



</head>

<body>


<div class="container-fluid main-container">


<!-- setup 3col/9col grid for toc_float and main content  -->
<div class="row-fluid">
<div class="col-xs-12 col-sm-4 col-md-3">
<div id="TOC" class="tocify">
</div>
</div>

<div class="toc-content col-xs-12 col-sm-8 col-md-9">




<div class="navbar navbar-inverse  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">CABW 2020 R training</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="index.html">
    <span class="fa fa-home fa-1.5x"></span>
     
  </a>
</li>
<li>
  <a href="setup.html">
    <span class="ion ion-hammer"></span>
     
    Setup R
  </a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    <span class="fa fa-bicycle fa-1x"></span>
     
    1: Data In, Plot Out!
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li class="dropdown-header">Lesson 1:</li>
    <li>
      <a href="usingr.html">
        <span class="fa fa-download"></span>
         
        Importing Data
      </a>
    </li>
    <li class="dropdown-header">Lesson 2:</li>
    <li>
      <a href="wrangleplot.html">
        <span class="fa fa-magic"></span>
         
        Wrangling Data
      </a>
    </li>
    <li class="dropdown-header">Lesson 3:</li>
    <li>
      <a href="in_progress.html">
        <span class="fa fa-area-chart"></span>
         
        Plotting with ggplot
      </a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    <span class="fa fa-car"></span>
     
    2: Excel to a Map
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li class="dropdown-header">Lesson 1:</li>
    <li>
      <a href="m2_1_working_w_xls.html">
        <span class="fa fa-table"></span>
         
        Working from Excel
      </a>
    </li>
    <li class="dropdown-header">Lesson 2:</li>
    <li>
      <a href="in_progress.html">
        <span class="fa fa-object-ungroup"></span>
         
        Joining Data
      </a>
    </li>
    <li class="dropdown-header">Lesson 3:</li>
    <li>
      <a href="in_progress.html">
        <span class="fa fa-globe-americas"></span>
         
        Using {sf}
      </a>
    </li>
    <li class="dropdown-header">Lesson 4:</li>
    <li>
      <a href="in_progress.html">
        <span class="fa fa-map-marked-alt"></span>
         
        Make a Map!
      </a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    <span class="fa fa-space-shuttle fa-1x"></span>
     
    And Beyond
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="in_progress.html">
        <span class="fa fa-box-open"></span>
         
        Helpful Packages
      </a>
    </li>
    <li>
      <a href="in_progress.html">
        <span class="fa fa-code-branch"></span>
         
        Running Functions
      </a>
    </li>
    <li>
      <a href="in_progress.html">
        <span class="fa fa-tint"></span>
         
        Downloading River Data
      </a>
    </li>
  </ul>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="resources.html">
    <span class="fa fa-list"></span>
     
    Resources
  </a>
</li>
<li>
  <a href="https://github.com/ucd-cws/CABW2020_R_training">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="https://twitter.com/CalSFSsocial">
    <span class="fa fa-twitter fa-lg"></span>
     
  </a>
</li>
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div class="fluid-row" id="header">



<h1 class="title toc-ignore">Mapping in R with <code>{sf}</code></h1>

</div>


<div id="sf" class="section level2">
<h2>Using <code>{sf}</code></h2>
<p>R is an open source software package, and more and more, it has become useful for analysis, visualization, and even writing. More recently, it has become a powerful tool for working with spatial data, making maps, etc. This is because it’s free (open source), it can do nearly everything that a GUI type program can do (e.g., ArcGIS), and you can write a script to do the same analysis many times over, saving time on repetitive tasks and making it clear how you did what you did.</p>
<p>There are a variety of spatial mapping/plotting packages in R. Currently, there are two main approaches to read/create spatial data in R. The <code>rgdal</code> package, and the <code>sf</code> package. We’re going to use the <code>sf</code> approach because it’s simpler and typically faster to work with, and spatial objects are simply <code>data.frames</code>, which makes it much easier to manipulate data.</p>
</div>
<div id="installload-packages" class="section level2">
<h2>Install/Load packages</h2>
<p>Next we need to install our packages (if you haven’t already). If you have already done this step, great, take a minute to look at the <a href="http://r-spatial.github.io/sf/"><code>sf</code> webpage</a> and the various vignettes that are available (see <strong><em>Articles</em></strong> tab).</p>
<pre class="r"><code># install packages if you haven&#39;t already
install.packages(c(&quot;viridis&quot;, &quot;sf&quot;,&quot;mapview&quot;, &quot;tmap&quot;,&quot;USAboundaries&quot;))

# load packages or &quot;libraries&quot;
library(tidyverse) # wrangling/plotting tools
library(viridis) # nice color palette
library(sf) # newer &quot;simple features&quot; spatial package
library(mapview) # interactive web mapping
library(tmap) # static mapping
library(USAboundaries) # data for USA boundaries</code></pre>
</div>
<div id="read-in-data" class="section level2">
<h2>Read in Data</h2>
<p>First we need to read in some data. We’ll be using the same data from earlier in the lessons…see the Github repository](<a href="https://github.com/SCCWRP/CABW2018_R_training/tree/master/data" class="uri">https://github.com/SCCWRP/CABW2018_R_training/tree/master/data</a>). Let’s use the <code>read_csv</code> function from the <code>tidyverse (readr)</code> package to read in our <code>.csv</code>’s. We can either download these files directly from the website, or we can use a downloaded file on our computer, following the data management/organization tips we spoke about earlier (i.e., using RStudio Projects, and always keep <strong>data</strong> in a <code>data</code> folder.</p>
<div id="read-data-from-local-rstudio-project" class="section level3">
<h3>Read Data from Local RStudio Project</h3>
<p>This assumes you’ve already downloaded the data from the <a href="https://sccwrp.github.io/CABW2018_R_training/">website</a> or from the Github data <a href="https://github.com/SCCWRP/CABW2018_R_training/tree/master/data">repository</a>.</p>
<pre class="r"><code># if reading locally (from your data folder in you RStudio project):
ascidat &lt;- read_csv(&quot;data/ascidat.csv&quot;)
cscidat &lt;- read_csv(&quot;data/cscidat.csv&quot;)
latlons &lt;- read_csv(&quot;data/latlon.csv&quot;)</code></pre>
</div>
<div id="read-data-from-website" class="section level3">
<h3>Read Data from Website</h3>
<p>This downloads data directly from the website (so you need to be connected to the internet).</p>
<pre class="r"><code># if reading from web:
ascidat &lt;- read_csv(&quot;https://raw.githubusercontent.com/SCCWRP/CABW2018_R_training/master/data/ascidat.csv&quot;)

cscidat &lt;- read_csv(&quot;https://raw.githubusercontent.com/SCCWRP/CABW2018_R_training/master/data/cscidat.csv&quot;)

# read in latitude/longitude data for sites:
#latlons &lt;- read_csv(&quot;https://raw.githubusercontent.com/SCCWRP/CABW2018_R_training/master/data/latlon.csv&quot;)

latlons &lt;- read_csv(file = &quot;https://raw.githubusercontent.com/SCCWRP/CABW2018_R_training/master/data/latlon.csv&quot;)</code></pre>
<p>Let’s take a look at our dataset, and in particular, let’s look at the coordinates we’ll be using to make our data “spatial”. The <code>latlons</code> dataset just has 3 columns. <strong><em>How many rows</em></strong>?</p>
<p>If we look at a summary of the latitude and longitude, what do we notice? Why might it be important to look at the latitude and longitude data<a href="#fn1" class="footnote-ref" id="fnref1"><sup>1</sup></a> before plotting?</p>
<pre class="r"><code>glimpse(latlons)</code></pre>
<pre><code>## Rows: 1,613
## Columns: 3
## $ StationID &lt;chr&gt; &quot;000CAT148&quot;, &quot;000CAT228&quot;, &quot;102PS0139&quot;, &quot;103CDCHHR&quot;, &quot;103FC1106&quot;, &quot;103FCA168&quot;, &quot;103KLCMSR&quot;, &quot;103PS0217&quot;, &quot;103RDCBCC&quot;, &quot;103WER026&quot;, &quot;103WER02…
## $ New_Lat   &lt;dbl&gt; 39.07523, 39.07307, 41.99595, 41.78890, 41.93407, 41.64962, 41.85546, 41.68691, 41.95481, 41.84999, 41.80977, 41.85649, 41.61202, 41.30818,…
## $ New_Long  &lt;dbl&gt; -119.8994, -119.9201, -122.9597, -124.0778, -124.1081, -124.0912, -123.8521, -124.0835, -124.0625, -124.0332, -124.1121, -123.9119, -123.29…</code></pre>
<pre class="r"><code>summary(latlons)</code></pre>
<pre><code>##   StationID            New_Lat         New_Long     
##  Length:1613        Min.   :32.55   Min.   :-124.1  
##  Class :character   1st Qu.:34.10   1st Qu.:-121.8  
##  Mode  :character   Median :36.55   Median :-119.3  
##                     Mean   :36.46   Mean   :-119.8  
##                     3rd Qu.:38.75   3rd Qu.:-117.8  
##                     Max.   :42.00   Max.   :-116.2</code></pre>
</div>
<div id="tidy-the-spatial-data" class="section level3">
<h3>Tidy the Spatial Data</h3>
<p>In case there is something amiss, such as values that aren’t negative, a quick fix is to run the following code to make sure all longitude values are negative.</p>
</div>
</div>
<div id="make-data-spatial" class="section level2">
<h2>Make Data Spatial</h2>
<p>Once we are sure our data are ok and things have been vetted, let’s make the data spatial and create a few quick test plots. To make the data spatial using <code>sf</code>, we need to know two important pieces…</p>
<ul>
<li>Which columns contain the spatial coordinates in (either name or column number)?</li>
<li>What <a href="http://spatialreference.org/ref/epsg/">projection</a> or <a href="http://epsg.io/">EPSG (CRS, SRID, etc)</a> is the data in/or that we want to use?</li>
</ul>
<div id="projectionstransformations" class="section level3">
<h3>Projections/Transformations</h3>
<p>Spatial data is tricky, because different parts of the world work in different “<em>datum</em>” or “<em>projections</em>”. The best description of how these work requires imagining draping a square tablecloth over a round ball (earth). The tablecloth isn’t quite big enough to cover the whole globe, so near the edges of the tablecoth there’s stretching. At the center of the tablecloth there’s very little stretching. When working with spatial data, we want a projection that is going to give us the least amount of stretching for the location/region we’re working in. A few common projections used in California for state/federal work:</p>
<ul>
<li><a href="http://epsg.io/3310">NAD83 California Albers: EPSG 3310</a></li>
<li><a href="http://spatialreference.org/ref/sr-org/10/">NAD83 California Teal Albers: SR-ORG:10</a></li>
<li><a href="http://epsg.io/4326">WGS84 Lat Lon: EPSG 4326</a></li>
</ul>
</div>
<div id="make-spatial-with-sf" class="section level3">
<h3>Make Spatial with <code>sf</code></h3>
<p>Here we read in the data and add a CRS projection.</p>
<pre class="r"><code># make data sf object: 
df_sf &lt;- st_as_sf(latlons,
                  # coords = c(&quot;Lon&quot;, &quot;Lat&quot;), # can use numbers here too
                  coords = c(3, 2), # can use numbers here too
                  remove = F, # don&#39;t remove these lat/lon cols from df
                  crs = 4326) # add projection (this is WGS84)</code></pre>
</div>
<div id="transform-or-convert-to-different-projection" class="section level3">
<h3>Transform or convert to different projection?</h3>
<p>Now that our data is in this format, it’s pretty easy to transform/convert to another spatial projection. Here we can switch the projection over to something different:</p>
<pre class="r"><code># check CRS first:
st_crs(df_sf)</code></pre>
<pre><code>## Coordinate Reference System:
##   User input: EPSG:4326 
##   wkt:
## GEOGCRS[&quot;WGS 84&quot;,
##     DATUM[&quot;World Geodetic System 1984&quot;,
##         ELLIPSOID[&quot;WGS 84&quot;,6378137,298.257223563,
##             LENGTHUNIT[&quot;metre&quot;,1]]],
##     PRIMEM[&quot;Greenwich&quot;,0,
##         ANGLEUNIT[&quot;degree&quot;,0.0174532925199433]],
##     CS[ellipsoidal,2],
##         AXIS[&quot;geodetic latitude (Lat)&quot;,north,
##             ORDER[1],
##             ANGLEUNIT[&quot;degree&quot;,0.0174532925199433]],
##         AXIS[&quot;geodetic longitude (Lon)&quot;,east,
##             ORDER[2],
##             ANGLEUNIT[&quot;degree&quot;,0.0174532925199433]],
##     USAGE[
##         SCOPE[&quot;unknown&quot;],
##         AREA[&quot;World&quot;],
##         BBOX[-90,-180,90,180]],
##     ID[&quot;EPSG&quot;,4326]]</code></pre>
<pre class="r"><code># change CRS using st_transform
df_sf_albers &lt;- st_transform(df_sf, crs=3310)

# check that it changed
st_crs(df_sf_albers)</code></pre>
<pre><code>## Coordinate Reference System:
##   User input: EPSG:3310 
##   wkt:
## PROJCRS[&quot;NAD83 / California Albers&quot;,
##     BASEGEOGCRS[&quot;NAD83&quot;,
##         DATUM[&quot;North American Datum 1983&quot;,
##             ELLIPSOID[&quot;GRS 1980&quot;,6378137,298.257222101,
##                 LENGTHUNIT[&quot;metre&quot;,1]]],
##         PRIMEM[&quot;Greenwich&quot;,0,
##             ANGLEUNIT[&quot;degree&quot;,0.0174532925199433]],
##         ID[&quot;EPSG&quot;,4269]],
##     CONVERSION[&quot;California Albers&quot;,
##         METHOD[&quot;Albers Equal Area&quot;,
##             ID[&quot;EPSG&quot;,9822]],
##         PARAMETER[&quot;Latitude of false origin&quot;,0,
##             ANGLEUNIT[&quot;degree&quot;,0.0174532925199433],
##             ID[&quot;EPSG&quot;,8821]],
##         PARAMETER[&quot;Longitude of false origin&quot;,-120,
##             ANGLEUNIT[&quot;degree&quot;,0.0174532925199433],
##             ID[&quot;EPSG&quot;,8822]],
##         PARAMETER[&quot;Latitude of 1st standard parallel&quot;,34,
##             ANGLEUNIT[&quot;degree&quot;,0.0174532925199433],
##             ID[&quot;EPSG&quot;,8823]],
##         PARAMETER[&quot;Latitude of 2nd standard parallel&quot;,40.5,
##             ANGLEUNIT[&quot;degree&quot;,0.0174532925199433],
##             ID[&quot;EPSG&quot;,8824]],
##         PARAMETER[&quot;Easting at false origin&quot;,0,
##             LENGTHUNIT[&quot;metre&quot;,1],
##             ID[&quot;EPSG&quot;,8826]],
##         PARAMETER[&quot;Northing at false origin&quot;,-4000000,
##             LENGTHUNIT[&quot;metre&quot;,1],
##             ID[&quot;EPSG&quot;,8827]]],
##     CS[Cartesian,2],
##         AXIS[&quot;easting (X)&quot;,east,
##             ORDER[1],
##             LENGTHUNIT[&quot;metre&quot;,1]],
##         AXIS[&quot;northing (Y)&quot;,north,
##             ORDER[2],
##             LENGTHUNIT[&quot;metre&quot;,1]],
##     USAGE[
##         SCOPE[&quot;unknown&quot;],
##         AREA[&quot;USA - California&quot;],
##         BBOX[32.53,-124.45,42.01,-114.12]],
##     ID[&quot;EPSG&quot;,3310]]</code></pre>
</div>
</div>
<div id="plot-sf-data" class="section level2">
<h2>Plot <code>sf</code> Data</h2>
<p>Now we can make a few quick plots to see how our data looks. The simplest option is to use the <code>plot</code> function. However, if we try to plot by running:</p>
<ul>
<li><code>plot(df_sf)</code></li>
</ul>
<p>We see something like this:</p>
<p><img src="images/plot_df_sf.png" /></p>
<p>Baseplotting functions work with <code>sf</code>, but be aware, using <code>plot</code> will default to plotting a facet or map for every <strong>column</strong> of data in your dataframe. Avoid that by specifying <code>st_coordinates()</code> or <code>$geometry</code> to ensure only the spatial data gets plotted.</p>
<div id="plotting-with-plot" class="section level3">
<h3>Plotting with <code>plot</code></h3>
<pre class="r"><code># single layer
plot(df_sf$geometry)</code></pre>
<p><img src="mapping_files/figure-html/singleSF1-1.png" width="672" /></p>
<pre class="r"><code># add some flair
plot(df_sf$geometry, col = &quot;orange&quot;)</code></pre>
<p><img src="mapping_files/figure-html/singleSF1-2.png" width="672" /></p>
</div>
<div id="quick-challenge" class="section level3">
<h3>Quick Challenge:</h3>
<blockquote>
<p><strong>How can we find out how to change the shape of the points using the <code>plot</code> function?</strong></p>
</blockquote>
<p>You can make plots as fancy as you want, here are a few additional options:</p>
<pre class="r"><code># this is better
plot(st_coordinates(df_sf), pch=16, col=adjustcolor(&quot;maroon&quot;, alpha=0.7), cex=1.5, xlab = &quot;Longitude&quot;, ylab=&quot;Latitude&quot;)
graphics::title(&quot;A Map in WGS84&quot;)</code></pre>
<p><img src="mapping_files/figure-html/singleSF2-1.png" width="672" /></p>
</div>
</div>
<div id="plotting-interactive-maps" class="section level2">
<h2>Plotting Interactive Maps</h2>
<p>One of the nicest/coolest packages you’ll find for mapping, is the <code>mapview</code> package. As long as data are in an <code>sf</code> format, you can quickly make some very nice and interactive maps of your data/sites. First let’s see what <code>class</code> of data we have:</p>
<pre class="r"><code># check data is in sf format?
class(df_sf)</code></pre>
<pre><code>## [1] &quot;sf&quot;          &quot;spec_tbl_df&quot; &quot;tbl_df&quot;      &quot;tbl&quot;         &quot;data.frame&quot;</code></pre>
<pre class="r"><code># should say: &quot;sf&quot;         &quot;tbl_df&quot;     &quot;tbl&quot;        &quot;data.frame&quot;

# make a map
mapview::mapview(df_sf)</code></pre>
<div id="htmlwidget-4c2528355b6a11740daa" style="width:672px;height:480px;" class="leaflet html-widget"></div>
<script type="application/json" data-for="htmlwidget-4c2528355b6a11740daa">{"x":{"options":{"minZoom":1,"maxZoom":52,"crs":{"crsClass":"L.CRS.EPSG3857","code":null,"proj4def":null,"projectedBounds":null,"options":{}},"preferCanvas":false,"bounceAtZoomLimits":false,"maxBounds":[[[-90,-370]],[[90,370]]]},"calls":[{"method":"addProviderTiles","args":["CartoDB.Positron","CartoDB.Positron","CartoDB.Positron",{"errorTileUrl":"","noWrap":false,"detectRetina":false,"pane":"tilePane"}]},{"method":"addProviderTiles","args":["CartoDB.DarkMatter","CartoDB.DarkMatter","CartoDB.DarkMatter",{"errorTileUrl":"","noWrap":false,"detectRetina":false,"pane":"tilePane"}]},{"method":"addProviderTiles","args":["OpenStreetMap","OpenStreetMap","OpenStreetMap",{"errorTileUrl":"","noWrap":false,"detectRetina":false,"pane":"tilePane"}]},{"method":"addProviderTiles","args":["Esri.WorldImagery","Esri.WorldImagery","Esri.WorldImagery",{"errorTileUrl":"","noWrap":false,"detectRetina":false,"pane":"tilePane"}]},{"method":"addProviderTiles","args":["OpenTopoMap","OpenTopoMap","OpenTopoMap",{"errorTileUrl":"","noWrap":false,"detectRetina":false,"pane":"tilePane"}]},{"method":"createMapPane","args":["point",440]},{"method":"addFlatGeoBuf","args":["df_sf","df_sf",null,true,"mvFeatureId",{"radius":6,"stroke":true,"color":"#333333","weight":1,"opacity":0.9,"fill":true,"fillColor":"#6666FF","fillOpacity":0.6},{"className":"","pane":"point"},"mapview-popup",{"radius":{"to":[3,15],"from":[3,15]},"weight":{"to":[1,10],"from":[1,10]},"opacity":{"to":[0,1],"from":[0,1]},"fillOpacity":{"to":[0,1],"from":[0,1]}}]},{"method":"addScaleBar","args":[{"maxWidth":100,"metric":true,"imperial":true,"updateWhenIdle":true,"position":"bottomleft"}]},{"method":"addHomeButton","args":[-124.11628,32.54938,-116.22256,41.9959481,"df_sf","Zoom to df_sf","<strong> df_sf <\/strong>","bottomright"]},{"method":"addLayersControl","args":[["CartoDB.Positron","CartoDB.DarkMatter","OpenStreetMap","Esri.WorldImagery","OpenTopoMap"],"df_sf",{"collapsed":true,"autoZIndex":true,"position":"topleft"}]},{"method":"addLegend","args":[{"colors":["#6666FF"],"labels":["df_sf"],"na_color":null,"na_label":"NA","opacity":1,"position":"topright","type":"factor","title":"","extra":null,"layerId":null,"className":"info legend","group":"df_sf"}]}],"fitBounds":[32.54938,-124.11628,41.9959481,-116.22256,[]]},"evals":[],"jsHooks":{"render":[{"code":"function(el, x, data) {\n  return (\n      function(el, x, data) {\n      // get the leaflet map\n      var map = this; //HTMLWidgets.find('#' + el.id);\n      // we need a new div element because we have to handle\n      // the mouseover output separately\n      // debugger;\n      function addElement () {\n      // generate new div Element\n      var newDiv = $(document.createElement('div'));\n      // append at end of leaflet htmlwidget container\n      $(el).append(newDiv);\n      //provide ID and style\n      newDiv.addClass('lnlt');\n      newDiv.css({\n      'position': 'relative',\n      'bottomleft':  '0px',\n      'background-color': 'rgba(255, 255, 255, 0.7)',\n      'box-shadow': '0 0 2px #bbb',\n      'background-clip': 'padding-box',\n      'margin': '0',\n      'padding-left': '5px',\n      'color': '#333',\n      'font': '9px/1.5 \"Helvetica Neue\", Arial, Helvetica, sans-serif',\n      'z-index': '700',\n      });\n      return newDiv;\n      }\n\n\n      // check for already existing lnlt class to not duplicate\n      var lnlt = $(el).find('.lnlt');\n\n      if(!lnlt.length) {\n      lnlt = addElement();\n\n      // grab the special div we generated in the beginning\n      // and put the mousmove output there\n\n      map.on('mousemove', function (e) {\n      if (e.originalEvent.ctrlKey) {\n      if (document.querySelector('.lnlt') === null) lnlt = addElement();\n      lnlt.text(\n                           ' lon: ' + (e.latlng.lng).toFixed(5) +\n                           ' | lat: ' + (e.latlng.lat).toFixed(5) +\n                           ' | zoom: ' + map.getZoom() +\n                           ' | x: ' + L.CRS.EPSG3857.project(e.latlng).x.toFixed(0) +\n                           ' | y: ' + L.CRS.EPSG3857.project(e.latlng).y.toFixed(0) +\n                           ' | epsg: 3857 ' +\n                           ' | proj4: +proj=merc +a=6378137 +b=6378137 +lat_ts=0.0 +lon_0=0.0 +x_0=0.0 +y_0=0 +k=1.0 +units=m +nadgrids=@null +no_defs ');\n      } else {\n      if (document.querySelector('.lnlt') === null) lnlt = addElement();\n      lnlt.text(\n                      ' lon: ' + (e.latlng.lng).toFixed(5) +\n                      ' | lat: ' + (e.latlng.lat).toFixed(5) +\n                      ' | zoom: ' + map.getZoom() + ' ');\n      }\n      });\n\n      // remove the lnlt div when mouse leaves map\n      map.on('mouseout', function (e) {\n      var strip = document.querySelector('.lnlt');\n      if( strip !==null) strip.remove();\n      });\n\n      };\n\n      //$(el).keypress(67, function(e) {\n      map.on('preclick', function(e) {\n      if (e.originalEvent.ctrlKey) {\n      if (document.querySelector('.lnlt') === null) lnlt = addElement();\n      lnlt.text(\n                      ' lon: ' + (e.latlng.lng).toFixed(5) +\n                      ' | lat: ' + (e.latlng.lat).toFixed(5) +\n                      ' | zoom: ' + map.getZoom() + ' ');\n      var txt = document.querySelector('.lnlt').textContent;\n      console.log(txt);\n      //txt.innerText.focus();\n      //txt.select();\n      setClipboardText('\"' + txt + '\"');\n      }\n      });\n\n      }\n      ).call(this.getMap(), el, x, data);\n}","data":null},{"code":"function(el, x, data) {\n  return (function(el,x,data){\n           var map = this;\n\n           map.on('keypress', function(e) {\n               console.log(e.originalEvent.code);\n               var key = e.originalEvent.code;\n               if (key === 'KeyE') {\n                   var bb = this.getBounds();\n                   var txt = JSON.stringify(bb);\n                   console.log(txt);\n\n                   setClipboardText('\\'' + txt + '\\'');\n               }\n           })\n        }).call(this.getMap(), el, x, data);\n}","data":null}]}}</script>
<p>Pretty cool!</p>
<div class="figure"><span id="fig:frogFarside"></span>
<img src="images/frog_stuck_on_plane.jpg" alt="Hanging on still?" width="250" height="70%" />
<p class="caption">
Figure 1: Hanging on still?
</p>
</div>
</div>
<div id="spatial-operations" class="section level1">
<h1>Spatial Operations</h1>
<p>Now that we can get data into R, and transform and plot our data, what about other spatial data or operations? The <code>sf</code> package can do nearly all the same things you can do in GIS software, buffer, crop, clip, merge, etc. For a full list and some nice vignettes, check out the <code>sf</code> page: <a href="https://r-spatial.github.io/sf/" class="uri">https://r-spatial.github.io/sf/</a>, and click on the <strong>Articles</strong> tab.</p>
<p>There’s simply too much to show and not enough time, but below are a few bonus activities we can work through. I’ll show how to crop or clip one spatial dataset using another spatial dataset, and eventually how to read/write <code>shapefiles</code> and <code>geopackages</code>.</p>
<div id="get-some-boundary-data-for-states" class="section level2">
<h2>Get some Boundary Data for States</h2>
<p>Now we have our data, let’s use some boundaries to crop/buffer and manipulate the data. While there are loads of options available, I’ll show two. A package called <code>USAboundaries</code>, which allows us to quickly download county or state outlines, in <code>sf</code> formats. Very handy for making some quick professional maps. Let’s get an outline of CA and add our points to a map.</p>
<pre class="r"><code>library(USAboundaries)

# Pick a State
state_names &lt;- c(&quot;california&quot;) # notice we can add more states to this list if we want

# Download STATE data and add projection
CA&lt;-us_states(resolution = &quot;high&quot;, states = state_names) # what does resolution do?

st_crs(CA) # double check the CRS</code></pre>
<pre><code>## Coordinate Reference System:
##   User input: EPSG:4326 
##   wkt:
## GEOGCRS[&quot;WGS 84&quot;,
##     DATUM[&quot;World Geodetic System 1984&quot;,
##         ELLIPSOID[&quot;WGS 84&quot;,6378137,298.257223563,
##             LENGTHUNIT[&quot;metre&quot;,1]]],
##     PRIMEM[&quot;Greenwich&quot;,0,
##         ANGLEUNIT[&quot;degree&quot;,0.0174532925199433]],
##     CS[ellipsoidal,2],
##         AXIS[&quot;geodetic latitude (Lat)&quot;,north,
##             ORDER[1],
##             ANGLEUNIT[&quot;degree&quot;,0.0174532925199433]],
##         AXIS[&quot;geodetic longitude (Lon)&quot;,east,
##             ORDER[2],
##             ANGLEUNIT[&quot;degree&quot;,0.0174532925199433]],
##     USAGE[
##         SCOPE[&quot;unknown&quot;],
##         AREA[&quot;World&quot;],
##         BBOX[-90,-180,90,180]],
##     ID[&quot;EPSG&quot;,4326]]</code></pre>
<pre class="r"><code># make a quick plot!
plot(CA$geometry)

# add data from above? use &quot;add=TRUE&quot;
plot(df_sf$geometry, col=&quot;blue&quot;, add=TRUE)</code></pre>
<p><img src="mapping_files/figure-html/getCA-1.png" width="672" /></p>
<div id="quick-challenge-1" class="section level4">
<h4>Quick Challenge:</h4>
<blockquote>
<p><strong>Download the State outline for Oregon &amp; California</strong> using the <code>USAboundaries</code> package and make a quick plot with our point data</p>
</blockquote>
</div>
</div>
<div id="plotting-with-ggplot" class="section level2">
<h2>Plotting with <code>ggplot</code></h2>
<p>Alternatively, we can use <code>ggplot2</code> instead. This is where <code>sf</code> objects are really nice. They fit well within the ggplot framework because they are simply dataframes with a spatial list-column layout. You can plot the X/Y data as part of a <code>geom_point</code> layer, or you can use the <code>geom_sf</code> function for more complex <code>sf</code> objects.</p>
<!-- The only caveat here is we currently (as of 2020-09-10) need the most recent version of `ggplot2`: 3.3.2 (use `packageVersion("ggplot2)` to check). If you don't have this, you can try installing the development version from github: -->
<!-- ```{r, eval=F, echo=T} -->
<!-- #install.packages("devtools") -->
<!-- devtools::install_github("tidyverse/ggplot2") -->
<!-- ``` -->
<!-- Once we have the dev version of `ggplot2`, we can make a fancier plot. -->
<p>So let’s load some background imagery and add it to our plot.</p>
<pre class="r"><code>nicemap&lt;-
  ggplot() + # set up the framework
  geom_sf(data = CA, color=&quot;gray&quot;, lwd=2) + # add the state outline using geom_sf
  geom_point(data=df_sf, aes(x=New_Long, y=New_Lat), fill=&quot;orange&quot;, pch=21, alpha=0.7, size=2)+
  labs(x=&quot;Longitude (WGS84)&quot;, y=&quot;Latitude&quot;, title=&quot;Map of Points&quot;) + 
  theme_bw() # change this to sans if it doesn&#39;t plot
nicemap</code></pre>
<p><img src="mapping_files/figure-html/GGsf-1.png" width="672" /></p>
<pre class="r"><code># To save plot
# ggsave(filename = &quot;./figs/site_map_ggplot.png&quot;, width = 8, height = 6, units = &quot;in&quot;, dpi = 300)</code></pre>
</div>
<div id="crop-by-a-county-and-join-with-csci-data" class="section level2">
<h2>Crop by A County and Join with CSCI Data</h2>
<p>Ok, let’s include our other dataset and try to tie this all together. Here’s what we are going to do:</p>
<ul>
<li>Download county data for CA (use <code>USAboundaries</code> package)</li>
<li>Select a county of interest (use some <code>dplyr</code>)</li>
<li>Crop our data to just that county (make a map)</li>
<li>Join our county subset with the CSCI data</li>
<li>Make an interactive plot colored by CSCI value (<code>mapview</code> and <code>viridis</code>)</li>
</ul>
<p><strong>So, first let’s grab counties for CA and subset:</strong></p>
<pre class="r"><code># Download outlines of all the counties for California
CA_counties&lt;-us_counties(resolution = &quot;high&quot;, states = &quot;CA&quot;) # what does resolution do?

# Pick a county of interest
co_names &lt;- c(&quot;Sacramento&quot;) # notice we can add more states to this list if we want

# filter to just that county:
sacto_co &lt;- filter(CA_counties, name==co_names)</code></pre>
<p><strong>Now let’s make a test map to make sure this data works/plots:</strong></p>
<pre class="r"><code>ggplot() + 
  geom_sf(data=CA_counties, col=&quot;gray&quot;, alpha=0.5, lty=2) + # all counties
  geom_sf(data=sacto_co, col=&quot;purple&quot;, fill=&quot;purple2&quot;, alpha=0.8)+
  theme_bw()</code></pre>
<p><img src="mapping_files/figure-html/mapCounties-1.png" width="672" /></p>
<p>Great, we have spatial data now for counties, and we can use this to crop our existing point data.</p>
<div id="crop-points-to-sacramento-county" class="section level3">
<h3>Crop points to Sacramento County</h3>
<p>Now we want to clip our point data down to only points in Sacramento County. The quickest way to do this is using <code>st_intersection</code>.</p>
<pre class="r"><code># we list the thing we want to crop down first, then what we crop by second
sacto_pts &lt;- st_intersection(df_sf, sacto_co)

plot(sacto_co$geometry)
plot(df_sf$geometry, add=T, col=&quot;gray&quot;) # all the points
plot(sacto_pts$geometry, add=T, bg =&quot;purple&quot;, pch=21) # just the points we cropped</code></pre>
<p><img src="mapping_files/figure-html/stIntersection-1.png" width="672" /></p>
</div>
<div id="join-data-to-csci" class="section level3">
<h3>Join Data to CSCI</h3>
<p>Now let’s join this subset of localities in Sacramento County to the data we read into R earlier. The CSCI data!</p>
<pre class="r"><code># need to specify what column we are joining by if the columns don&#39;t match exactly
sacto_csci &lt;- left_join(sacto_pts, cscidat, by= c(&quot;StationID&quot;=&quot;StationCode&quot;))

plot(sacto_co$geometry, col=&quot;gray&quot;)
plot(sacto_csci$geometry, add=T, bg=&quot;purple&quot;, pch=21)</code></pre>
<p><img src="mapping_files/figure-html/joins-1.png" width="672" /></p>
</div>
<div id="interactive-map" class="section level3">
<h3>Interactive Map!</h3>
<p>Finally, let’s make a dynamic map that shows the CSCI scores!</p>
<pre class="r"><code>mapview(sacto_csci, zcol=&quot;CSCI&quot;, layer=&quot;CSCI&quot;)</code></pre>
<div id="htmlwidget-098f2005ff99ea9012d0" style="width:672px;height:480px;" class="leaflet html-widget"></div>
<script type="application/json" data-for="htmlwidget-098f2005ff99ea9012d0">{"x":{"options":{"minZoom":1,"maxZoom":52,"crs":{"crsClass":"L.CRS.EPSG3857","code":null,"proj4def":null,"projectedBounds":null,"options":{}},"preferCanvas":false,"bounceAtZoomLimits":false,"maxBounds":[[[-90,-370]],[[90,370]]]},"calls":[{"method":"addProviderTiles","args":["CartoDB.Positron","CartoDB.Positron","CartoDB.Positron",{"errorTileUrl":"","noWrap":false,"detectRetina":false,"pane":"tilePane"}]},{"method":"addProviderTiles","args":["CartoDB.DarkMatter","CartoDB.DarkMatter","CartoDB.DarkMatter",{"errorTileUrl":"","noWrap":false,"detectRetina":false,"pane":"tilePane"}]},{"method":"addProviderTiles","args":["OpenStreetMap","OpenStreetMap","OpenStreetMap",{"errorTileUrl":"","noWrap":false,"detectRetina":false,"pane":"tilePane"}]},{"method":"addProviderTiles","args":["Esri.WorldImagery","Esri.WorldImagery","Esri.WorldImagery",{"errorTileUrl":"","noWrap":false,"detectRetina":false,"pane":"tilePane"}]},{"method":"addProviderTiles","args":["OpenTopoMap","OpenTopoMap","OpenTopoMap",{"errorTileUrl":"","noWrap":false,"detectRetina":false,"pane":"tilePane"}]},{"method":"createMapPane","args":["point",440]},{"method":"addFlatGeoBuf","args":["CSCI","CSCI",null,true,"CSCI",{"radius":6,"stroke":true,"color":"#333333","weight":1,"opacity":0.9,"fill":true,"fillColor":null,"fillOpacity":0.6},{"className":"","pane":"point"},"mapview-popup",{"radius":{"to":[3,15],"from":[3,15]},"weight":{"to":[1,10],"from":[1,10]},"opacity":{"to":[0,1],"from":[0,1]},"fillOpacity":{"to":[0,1],"from":[0,1]}}]},{"method":"addScaleBar","args":[{"maxWidth":100,"metric":true,"imperial":true,"updateWhenIdle":true,"position":"bottomleft"}]},{"method":"addHomeButton","args":[-121.44147,38.4168745,-121.24055,38.7170691,"CSCI","Zoom to CSCI","<strong> CSCI <\/strong>","bottomright"]},{"method":"addLayersControl","args":[["CartoDB.Positron","CartoDB.DarkMatter","OpenStreetMap","Esri.WorldImagery","OpenTopoMap"],"CSCI",{"collapsed":true,"autoZIndex":true,"position":"topleft"}]},{"method":"addLegend","args":[{"colors":["#4B0055 , #471D67 7.16844866498123%, #2C4680 19.0916923071053%, #016992 31.0149359492294%, #008A98 42.9381795913535%, #02A790 54.8614232334776%, #14BF7C 66.7846668756016%, #74D25B 78.7079105177257%, #C6DE34 90.6311541598498%, #FDE333 "],"labels":["0.25","0.30","0.35","0.40","0.45","0.50","0.55","0.60"],"na_color":null,"na_label":"NA","opacity":1,"position":"topright","type":"numeric","title":"CSCI","extra":{"p_1":0.0716844866498123,"p_n":0.906311541598498},"layerId":null,"className":"info legend","group":"CSCI"}]}],"fitBounds":[38.4168745,-121.44147,38.7170691,-121.24055,[]]},"evals":[],"jsHooks":{"render":[{"code":"function(el, x, data) {\n  return (\n      function(el, x, data) {\n      // get the leaflet map\n      var map = this; //HTMLWidgets.find('#' + el.id);\n      // we need a new div element because we have to handle\n      // the mouseover output separately\n      // debugger;\n      function addElement () {\n      // generate new div Element\n      var newDiv = $(document.createElement('div'));\n      // append at end of leaflet htmlwidget container\n      $(el).append(newDiv);\n      //provide ID and style\n      newDiv.addClass('lnlt');\n      newDiv.css({\n      'position': 'relative',\n      'bottomleft':  '0px',\n      'background-color': 'rgba(255, 255, 255, 0.7)',\n      'box-shadow': '0 0 2px #bbb',\n      'background-clip': 'padding-box',\n      'margin': '0',\n      'padding-left': '5px',\n      'color': '#333',\n      'font': '9px/1.5 \"Helvetica Neue\", Arial, Helvetica, sans-serif',\n      'z-index': '700',\n      });\n      return newDiv;\n      }\n\n\n      // check for already existing lnlt class to not duplicate\n      var lnlt = $(el).find('.lnlt');\n\n      if(!lnlt.length) {\n      lnlt = addElement();\n\n      // grab the special div we generated in the beginning\n      // and put the mousmove output there\n\n      map.on('mousemove', function (e) {\n      if (e.originalEvent.ctrlKey) {\n      if (document.querySelector('.lnlt') === null) lnlt = addElement();\n      lnlt.text(\n                           ' lon: ' + (e.latlng.lng).toFixed(5) +\n                           ' | lat: ' + (e.latlng.lat).toFixed(5) +\n                           ' | zoom: ' + map.getZoom() +\n                           ' | x: ' + L.CRS.EPSG3857.project(e.latlng).x.toFixed(0) +\n                           ' | y: ' + L.CRS.EPSG3857.project(e.latlng).y.toFixed(0) +\n                           ' | epsg: 3857 ' +\n                           ' | proj4: +proj=merc +a=6378137 +b=6378137 +lat_ts=0.0 +lon_0=0.0 +x_0=0.0 +y_0=0 +k=1.0 +units=m +nadgrids=@null +no_defs ');\n      } else {\n      if (document.querySelector('.lnlt') === null) lnlt = addElement();\n      lnlt.text(\n                      ' lon: ' + (e.latlng.lng).toFixed(5) +\n                      ' | lat: ' + (e.latlng.lat).toFixed(5) +\n                      ' | zoom: ' + map.getZoom() + ' ');\n      }\n      });\n\n      // remove the lnlt div when mouse leaves map\n      map.on('mouseout', function (e) {\n      var strip = document.querySelector('.lnlt');\n      if( strip !==null) strip.remove();\n      });\n\n      };\n\n      //$(el).keypress(67, function(e) {\n      map.on('preclick', function(e) {\n      if (e.originalEvent.ctrlKey) {\n      if (document.querySelector('.lnlt') === null) lnlt = addElement();\n      lnlt.text(\n                      ' lon: ' + (e.latlng.lng).toFixed(5) +\n                      ' | lat: ' + (e.latlng.lat).toFixed(5) +\n                      ' | zoom: ' + map.getZoom() + ' ');\n      var txt = document.querySelector('.lnlt').textContent;\n      console.log(txt);\n      //txt.innerText.focus();\n      //txt.select();\n      setClipboardText('\"' + txt + '\"');\n      }\n      });\n\n      }\n      ).call(this.getMap(), el, x, data);\n}","data":null},{"code":"function(el, x, data) {\n  return (function(el,x,data){\n           var map = this;\n\n           map.on('keypress', function(e) {\n               console.log(e.originalEvent.code);\n               var key = e.originalEvent.code;\n               if (key === 'KeyE') {\n                   var bb = this.getBounds();\n                   var txt = JSON.stringify(bb);\n                   console.log(txt);\n\n                   setClipboardText('\\'' + txt + '\\'');\n               }\n           })\n        }).call(this.getMap(), el, x, data);\n}","data":null}]}}</script>
<pre class="r"><code># add another layer by linking with &quot;+&quot;

mapview(sacto_co, layer=&quot;Sacramento County&quot;) +
  mapview(sacto_csci, zcol=&quot;CSCI&quot;, layer=&quot;CSCI&quot;)</code></pre>
<div id="htmlwidget-728387806dc501da15bc" style="width:672px;height:480px;" class="leaflet html-widget"></div>
<script type="application/json" data-for="htmlwidget-728387806dc501da15bc">{"x":{"options":{"minZoom":1,"maxZoom":52,"crs":{"crsClass":"L.CRS.EPSG3857","code":null,"proj4def":null,"projectedBounds":null,"options":{}},"preferCanvas":false,"bounceAtZoomLimits":false,"maxBounds":[[[-90,-370]],[[90,370]]]},"calls":[{"method":"addProviderTiles","args":["CartoDB.Positron","CartoDB.Positron","CartoDB.Positron",{"errorTileUrl":"","noWrap":false,"detectRetina":false,"pane":"tilePane"}]},{"method":"addProviderTiles","args":["CartoDB.DarkMatter","CartoDB.DarkMatter","CartoDB.DarkMatter",{"errorTileUrl":"","noWrap":false,"detectRetina":false,"pane":"tilePane"}]},{"method":"addProviderTiles","args":["OpenStreetMap","OpenStreetMap","OpenStreetMap",{"errorTileUrl":"","noWrap":false,"detectRetina":false,"pane":"tilePane"}]},{"method":"addProviderTiles","args":["Esri.WorldImagery","Esri.WorldImagery","Esri.WorldImagery",{"errorTileUrl":"","noWrap":false,"detectRetina":false,"pane":"tilePane"}]},{"method":"addProviderTiles","args":["OpenTopoMap","OpenTopoMap","OpenTopoMap",{"errorTileUrl":"","noWrap":false,"detectRetina":false,"pane":"tilePane"}]},{"method":"createMapPane","args":["polygon",420]},{"method":"addFlatGeoBuf","args":["SacramentoCounty","Sacramento County",null,true,"mvFeatureId",{"radius":6,"stroke":true,"color":"#333333","weight":0.5,"opacity":0.9,"fill":true,"fillColor":"#6666FF","fillOpacity":0.6},{"className":"","pane":"polygon"},"mapview-popup",{"radius":{"to":[3,15],"from":[3,15]},"weight":{"to":[1,10],"from":[1,10]},"opacity":{"to":[0,1],"from":[0,1]},"fillOpacity":{"to":[0,1],"from":[0,1]}}]},{"method":"addScaleBar","args":[{"maxWidth":100,"metric":true,"imperial":true,"updateWhenIdle":true,"position":"bottomleft"}]},{"method":"addHomeButton","args":[-121.862542,38.018421,-121.027084,38.736401,"Sacramento County","Zoom to Sacramento County","<strong> Sacramento County <\/strong>","bottomright"]},{"method":"addLegend","args":[{"colors":["#6666FF"],"labels":["Sacramento County"],"na_color":null,"na_label":"NA","opacity":1,"position":"topright","type":"factor","title":"","extra":null,"layerId":null,"className":"info legend","group":"Sacramento County"}]},{"method":"createMapPane","args":["point",440]},{"method":"addFlatGeoBuf","args":["CSCI","CSCI",null,true,"CSCI",{"radius":6,"stroke":true,"color":"#333333","weight":1,"opacity":0.9,"fill":true,"fillColor":null,"fillOpacity":0.6},{"className":"","pane":"point"},"mapview-popup",{"radius":{"to":[3,15],"from":[3,15]},"weight":{"to":[1,10],"from":[1,10]},"opacity":{"to":[0,1],"from":[0,1]},"fillOpacity":{"to":[0,1],"from":[0,1]}}]},{"method":"addHomeButton","args":[-121.44147,38.4168745,-121.24055,38.7170691,"CSCI","Zoom to CSCI","<strong> CSCI <\/strong>","bottomright"]},{"method":"addLayersControl","args":[["CartoDB.Positron","CartoDB.DarkMatter","OpenStreetMap","Esri.WorldImagery","OpenTopoMap"],["Sacramento County","CSCI"],{"collapsed":true,"autoZIndex":true,"position":"topleft"}]},{"method":"addLegend","args":[{"colors":["#4B0055 , #471D67 7.16844866498123%, #2C4680 19.0916923071053%, #016992 31.0149359492294%, #008A98 42.9381795913535%, #02A790 54.8614232334776%, #14BF7C 66.7846668756016%, #74D25B 78.7079105177257%, #C6DE34 90.6311541598498%, #FDE333 "],"labels":["0.25","0.30","0.35","0.40","0.45","0.50","0.55","0.60"],"na_color":null,"na_label":"NA","opacity":1,"position":"topright","type":"numeric","title":"CSCI","extra":{"p_1":0.0716844866498123,"p_n":0.906311541598498},"layerId":null,"className":"info legend","group":"CSCI"}]},{"method":"addHomeButton","args":[-121.862542,38.018421,-121.027084,38.736401,null,"Zoom to full extent","<strong>Zoom full<\/strong>","bottomleft"]}],"fitBounds":[38.018421,-121.862542,38.736401,-121.027084,[]]},"evals":[],"jsHooks":{"render":[{"code":"function(el, x, data) {\n  return (\n      function(el, x, data) {\n      // get the leaflet map\n      var map = this; //HTMLWidgets.find('#' + el.id);\n      // we need a new div element because we have to handle\n      // the mouseover output separately\n      // debugger;\n      function addElement () {\n      // generate new div Element\n      var newDiv = $(document.createElement('div'));\n      // append at end of leaflet htmlwidget container\n      $(el).append(newDiv);\n      //provide ID and style\n      newDiv.addClass('lnlt');\n      newDiv.css({\n      'position': 'relative',\n      'bottomleft':  '0px',\n      'background-color': 'rgba(255, 255, 255, 0.7)',\n      'box-shadow': '0 0 2px #bbb',\n      'background-clip': 'padding-box',\n      'margin': '0',\n      'padding-left': '5px',\n      'color': '#333',\n      'font': '9px/1.5 \"Helvetica Neue\", Arial, Helvetica, sans-serif',\n      'z-index': '700',\n      });\n      return newDiv;\n      }\n\n\n      // check for already existing lnlt class to not duplicate\n      var lnlt = $(el).find('.lnlt');\n\n      if(!lnlt.length) {\n      lnlt = addElement();\n\n      // grab the special div we generated in the beginning\n      // and put the mousmove output there\n\n      map.on('mousemove', function (e) {\n      if (e.originalEvent.ctrlKey) {\n      if (document.querySelector('.lnlt') === null) lnlt = addElement();\n      lnlt.text(\n                           ' lon: ' + (e.latlng.lng).toFixed(5) +\n                           ' | lat: ' + (e.latlng.lat).toFixed(5) +\n                           ' | zoom: ' + map.getZoom() +\n                           ' | x: ' + L.CRS.EPSG3857.project(e.latlng).x.toFixed(0) +\n                           ' | y: ' + L.CRS.EPSG3857.project(e.latlng).y.toFixed(0) +\n                           ' | epsg: 3857 ' +\n                           ' | proj4: +proj=merc +a=6378137 +b=6378137 +lat_ts=0.0 +lon_0=0.0 +x_0=0.0 +y_0=0 +k=1.0 +units=m +nadgrids=@null +no_defs ');\n      } else {\n      if (document.querySelector('.lnlt') === null) lnlt = addElement();\n      lnlt.text(\n                      ' lon: ' + (e.latlng.lng).toFixed(5) +\n                      ' | lat: ' + (e.latlng.lat).toFixed(5) +\n                      ' | zoom: ' + map.getZoom() + ' ');\n      }\n      });\n\n      // remove the lnlt div when mouse leaves map\n      map.on('mouseout', function (e) {\n      var strip = document.querySelector('.lnlt');\n      if( strip !==null) strip.remove();\n      });\n\n      };\n\n      //$(el).keypress(67, function(e) {\n      map.on('preclick', function(e) {\n      if (e.originalEvent.ctrlKey) {\n      if (document.querySelector('.lnlt') === null) lnlt = addElement();\n      lnlt.text(\n                      ' lon: ' + (e.latlng.lng).toFixed(5) +\n                      ' | lat: ' + (e.latlng.lat).toFixed(5) +\n                      ' | zoom: ' + map.getZoom() + ' ');\n      var txt = document.querySelector('.lnlt').textContent;\n      console.log(txt);\n      //txt.innerText.focus();\n      //txt.select();\n      setClipboardText('\"' + txt + '\"');\n      }\n      });\n\n      }\n      ).call(this.getMap(), el, x, data);\n}","data":null},{"code":"function(el, x, data) {\n  return (function(el,x,data){\n           var map = this;\n\n           map.on('keypress', function(e) {\n               console.log(e.originalEvent.code);\n               var key = e.originalEvent.code;\n               if (key === 'KeyE') {\n                   var bb = this.getBounds();\n                   var txt = JSON.stringify(bb);\n                   console.log(txt);\n\n                   setClipboardText('\\'' + txt + '\\'');\n               }\n           })\n        }).call(this.getMap(), el, x, data);\n}","data":null}]}}</script>
</div>
<div id="static-map" class="section level3">
<h3>Static Map</h3>
<blockquote>
<p><strong>Challenge</strong>: Can you make the same map as below using ggplot? Hint, <code>viridis</code> may be useful here…</p>
</blockquote>
<p><img src="mapping_files/figure-html/staticCSCI-1.png" width="672" /></p>
</div>
</div>
<div id="saving-data-out-getting-it-back-in" class="section level2">
<h2>Saving Data Out &amp; Getting it Back In</h2>
<p>So we now can do a number of different things with spatial data, mapping, making a web map, cropping, etc. But a common task is saving spatial data for use in another program, or reading spatial data (i.e., typically <strong>shapefiles</strong>) into R.</p>
<p>We’ll walk through how to do that with the data we’ve used thus far.</p>
<div id="save-into-a-shapefile" class="section level3">
<h3>Save into a shapefile</h3>
<p>Shapefiles have been the de-facto data currency for spatial (vector-based) data for awhile. Newer more open-source formats are becoming easier to use (e.g., <em>geopackage</em>), but if you do anything spatial, you’ll have to use shapefiles at some point.</p>
<p>Let’s save one of our data layers into a shapefile. With the <code>sf</code> package, this is fairly straightforward.</p>
<pre class="r"><code># save out as a shapefile
st_write(obj = sacto_csci, &quot;data/sacramento_co_csci.shp&quot;, 
         delete_layer = TRUE ) # delete the existing layer if it already exists</code></pre>
<pre><code>## Deleting layer `sacramento_co_csci&#39; using driver `ESRI Shapefile&#39;
## Writing layer `sacramento_co_csci&#39; to data source `data/sacramento_co_csci.shp&#39; using driver `ESRI Shapefile&#39;
## Writing 15 features with 24 fields and geometry type Point.</code></pre>
<pre class="r"><code># warnings are ok, typically associated with field widths or field names.
# commonly I get this:
# Warning messages:
# 1: In abbreviate_shapefile_names(obj) :
#   Field names abbreviated for ESRI Shapefile driver</code></pre>
<p>How can we make sure this worked? Well we can go find the folder and check that there are 4 separate files ending with <code>.dbf</code>, <code>.prj</code>, <code>.shp</code>, and <code>.shx</code>. We can also read this data back into R and plot it to make sure it looks ok.</p>
<pre class="r"><code># select the path to the shp file
tst_shp &lt;- st_read(&quot;data/sacramento_co_csci.shp&quot;)</code></pre>
<pre><code>## Reading layer `sacramento_co_csci&#39; from data source `/Users/ryanpeek/Documents/github/TEACHING/2020_CABW_R_training/data/sacramento_co_csci.shp&#39; using driver `ESRI Shapefile&#39;
## Simple feature collection with 15 features and 24 fields
## geometry type:  POINT
## dimension:      XY
## bbox:           xmin: -121.4415 ymin: 38.41687 xmax: -121.2406 ymax: 38.71707
## geographic CRS: WGS 84</code></pre>
<pre class="r"><code>plot(tst_shp$geometry)</code></pre>
<p><img src="mapping_files/figure-html/readShp-1.png" width="672" /></p>
<pre class="r"><code>mapview(tst_shp)</code></pre>
<div id="htmlwidget-690cf7a0b625d990cdf5" style="width:672px;height:480px;" class="leaflet html-widget"></div>
<script type="application/json" data-for="htmlwidget-690cf7a0b625d990cdf5">{"x":{"options":{"minZoom":1,"maxZoom":52,"crs":{"crsClass":"L.CRS.EPSG3857","code":null,"proj4def":null,"projectedBounds":null,"options":{}},"preferCanvas":false,"bounceAtZoomLimits":false,"maxBounds":[[[-90,-370]],[[90,370]]]},"calls":[{"method":"addProviderTiles","args":["CartoDB.Positron","CartoDB.Positron","CartoDB.Positron",{"errorTileUrl":"","noWrap":false,"detectRetina":false,"pane":"tilePane"}]},{"method":"addProviderTiles","args":["CartoDB.DarkMatter","CartoDB.DarkMatter","CartoDB.DarkMatter",{"errorTileUrl":"","noWrap":false,"detectRetina":false,"pane":"tilePane"}]},{"method":"addProviderTiles","args":["OpenStreetMap","OpenStreetMap","OpenStreetMap",{"errorTileUrl":"","noWrap":false,"detectRetina":false,"pane":"tilePane"}]},{"method":"addProviderTiles","args":["Esri.WorldImagery","Esri.WorldImagery","Esri.WorldImagery",{"errorTileUrl":"","noWrap":false,"detectRetina":false,"pane":"tilePane"}]},{"method":"addProviderTiles","args":["OpenTopoMap","OpenTopoMap","OpenTopoMap",{"errorTileUrl":"","noWrap":false,"detectRetina":false,"pane":"tilePane"}]},{"method":"createMapPane","args":["point",440]},{"method":"addFlatGeoBuf","args":["tst_shp","tst_shp",null,true,"mvFeatureId",{"radius":6,"stroke":true,"color":"#333333","weight":1,"opacity":0.9,"fill":true,"fillColor":"#6666FF","fillOpacity":0.6},{"className":"","pane":"point"},"mapview-popup",{"radius":{"to":[3,15],"from":[3,15]},"weight":{"to":[1,10],"from":[1,10]},"opacity":{"to":[0,1],"from":[0,1]},"fillOpacity":{"to":[0,1],"from":[0,1]}}]},{"method":"addScaleBar","args":[{"maxWidth":100,"metric":true,"imperial":true,"updateWhenIdle":true,"position":"bottomleft"}]},{"method":"addHomeButton","args":[-121.44147,38.4168745,-121.24055,38.7170691,"tst_shp","Zoom to tst_shp","<strong> tst_shp <\/strong>","bottomright"]},{"method":"addLayersControl","args":[["CartoDB.Positron","CartoDB.DarkMatter","OpenStreetMap","Esri.WorldImagery","OpenTopoMap"],"tst_shp",{"collapsed":true,"autoZIndex":true,"position":"topleft"}]},{"method":"addLegend","args":[{"colors":["#6666FF"],"labels":["tst_shp"],"na_color":null,"na_label":"NA","opacity":1,"position":"topright","type":"factor","title":"","extra":null,"layerId":null,"className":"info legend","group":"tst_shp"}]}],"fitBounds":[38.4168745,-121.44147,38.7170691,-121.24055,[]]},"evals":[],"jsHooks":{"render":[{"code":"function(el, x, data) {\n  return (\n      function(el, x, data) {\n      // get the leaflet map\n      var map = this; //HTMLWidgets.find('#' + el.id);\n      // we need a new div element because we have to handle\n      // the mouseover output separately\n      // debugger;\n      function addElement () {\n      // generate new div Element\n      var newDiv = $(document.createElement('div'));\n      // append at end of leaflet htmlwidget container\n      $(el).append(newDiv);\n      //provide ID and style\n      newDiv.addClass('lnlt');\n      newDiv.css({\n      'position': 'relative',\n      'bottomleft':  '0px',\n      'background-color': 'rgba(255, 255, 255, 0.7)',\n      'box-shadow': '0 0 2px #bbb',\n      'background-clip': 'padding-box',\n      'margin': '0',\n      'padding-left': '5px',\n      'color': '#333',\n      'font': '9px/1.5 \"Helvetica Neue\", Arial, Helvetica, sans-serif',\n      'z-index': '700',\n      });\n      return newDiv;\n      }\n\n\n      // check for already existing lnlt class to not duplicate\n      var lnlt = $(el).find('.lnlt');\n\n      if(!lnlt.length) {\n      lnlt = addElement();\n\n      // grab the special div we generated in the beginning\n      // and put the mousmove output there\n\n      map.on('mousemove', function (e) {\n      if (e.originalEvent.ctrlKey) {\n      if (document.querySelector('.lnlt') === null) lnlt = addElement();\n      lnlt.text(\n                           ' lon: ' + (e.latlng.lng).toFixed(5) +\n                           ' | lat: ' + (e.latlng.lat).toFixed(5) +\n                           ' | zoom: ' + map.getZoom() +\n                           ' | x: ' + L.CRS.EPSG3857.project(e.latlng).x.toFixed(0) +\n                           ' | y: ' + L.CRS.EPSG3857.project(e.latlng).y.toFixed(0) +\n                           ' | epsg: 3857 ' +\n                           ' | proj4: +proj=merc +a=6378137 +b=6378137 +lat_ts=0.0 +lon_0=0.0 +x_0=0.0 +y_0=0 +k=1.0 +units=m +nadgrids=@null +no_defs ');\n      } else {\n      if (document.querySelector('.lnlt') === null) lnlt = addElement();\n      lnlt.text(\n                      ' lon: ' + (e.latlng.lng).toFixed(5) +\n                      ' | lat: ' + (e.latlng.lat).toFixed(5) +\n                      ' | zoom: ' + map.getZoom() + ' ');\n      }\n      });\n\n      // remove the lnlt div when mouse leaves map\n      map.on('mouseout', function (e) {\n      var strip = document.querySelector('.lnlt');\n      if( strip !==null) strip.remove();\n      });\n\n      };\n\n      //$(el).keypress(67, function(e) {\n      map.on('preclick', function(e) {\n      if (e.originalEvent.ctrlKey) {\n      if (document.querySelector('.lnlt') === null) lnlt = addElement();\n      lnlt.text(\n                      ' lon: ' + (e.latlng.lng).toFixed(5) +\n                      ' | lat: ' + (e.latlng.lat).toFixed(5) +\n                      ' | zoom: ' + map.getZoom() + ' ');\n      var txt = document.querySelector('.lnlt').textContent;\n      console.log(txt);\n      //txt.innerText.focus();\n      //txt.select();\n      setClipboardText('\"' + txt + '\"');\n      }\n      });\n\n      }\n      ).call(this.getMap(), el, x, data);\n}","data":null},{"code":"function(el, x, data) {\n  return (function(el,x,data){\n           var map = this;\n\n           map.on('keypress', function(e) {\n               console.log(e.originalEvent.code);\n               var key = e.originalEvent.code;\n               if (key === 'KeyE') {\n                   var bb = this.getBounds();\n                   var txt = JSON.stringify(bb);\n                   console.log(txt);\n\n                   setClipboardText('\\'' + txt + '\\'');\n               }\n           })\n        }).call(this.getMap(), el, x, data);\n}","data":null}]}}</script>
</div>
</div>
<div id="interested-in-learning-more" class="section level2">
<h2>Interested in Learning More?</h2>
<p>There are loads of resources…but a geospatial workshop you may want to check out is run by the Carpentries. Lessons/material are freely available here:</p>
<ul>
<li><a href="https://datacarpentry.org/geospatial-workshop/" class="uri">https://datacarpentry.org/geospatial-workshop/</a></li>
</ul>
</div>
</div>
<div class="footnotes">
<hr />
<ol>
<li id="fn1"><p>For data from the North American continent, and when using the <strong><code>WGS84</code></strong> datum, keep an eye on your lat/long coordinates, especially <strong>longitude</strong>. It typically should be <code>negative</code>. A common snafu that can occur is a few values (or all) from the longitude column may remain positive, which means the data typically plots somewhere in the Indian Ocean. Make sure all your longitudes are negative (if in the US and using lat/longs).<a href="#fnref1" class="footnote-back">↩︎</a></p></li>
</ol>
</div>

<!DOCTYPE html>

<!-- Add icon library -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">


<div class="foot">
	<hr> 
	<p style="text-align: center;">
	  <span style="color: #808080; display: inline-block; width: 58%;">
	  &#9781 &nbsp;<i>Website design by <a href="https://ryanpeek.org/">Ryan Peek</i></a> &nbsp;  
    <a href="https://github.com/Cal-SFS/" class="fa fa-github">Cal-SFS</a> &nbsp; &#9781
    </span>
  </p>
</div>


</div>
</div>

</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.header').parent('thead').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open')
  });
});
</script>

<!-- code folding -->

<script>
$(document).ready(function ()  {

    // move toc-ignore selectors from section div to header
    $('div.section.toc-ignore')
        .removeClass('toc-ignore')
        .children('h1,h2,h3,h4,h5').addClass('toc-ignore');

    // establish options
    var options = {
      selectors: "h1,h2,h3",
      theme: "bootstrap3",
      context: '.toc-content',
      hashGenerator: function (text) {
        return text.replace(/[.\\/?&!#<>]/g, '').replace(/\s/g, '_');
      },
      ignoreSelector: ".toc-ignore",
      scrollTo: 0
    };
    options.showAndHide = true;
    options.smoothScroll = true;

    // tocify
    var toc = $("#TOC").tocify(options).data("toc-tocify");
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
